<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>Your Service Connection Credentials Are Mine - DevJev.nl | Azure, Cloud Security &amp; DevOps Insights for IT Professionals</title><meta name="author" content="Jev">
<meta name="description" content="A demonstration of service connection credentials exfiltration through an Azure DevOps pipeline"><meta name="keywords" content='Azure DevOps, Pipelines, Hack, Service connection, Zero Trust, Credentials, Service Connection security, Pipeline permissions'>
  <meta itemprop="name" content="Your service connection credentials are mine">
  <meta itemprop="description" content="A demonstration of service connection credentials exfiltration through an Azure DevOps pipeline">
  <meta itemprop="datePublished" content="2022-03-12T21:00:00+01:00">
  <meta itemprop="dateModified" content="2022-03-12T21:00:00+01:00">
  <meta itemprop="wordCount" content="1018">
  <meta itemprop="image" content="https://www.devjev.nl/posts/2022/your-service-connection-credentials-are-mine/featured-image.jpg">
  <meta itemprop="keywords" content="Azure DevOps,Pipelines,Hack,Service Connection,Zero Trust,Credentials,Service Connection Security,Pipeline Permissions"><meta property="og:url" content="https://www.devjev.nl/posts/2022/your-service-connection-credentials-are-mine/">
  <meta property="og:site_name" content="DevJev.nl | Azure, Cloud Security & DevOps Insights for IT Professionals">
  <meta property="og:title" content="Your service connection credentials are mine">
  <meta property="og:description" content="A demonstration of service connection credentials exfiltration through an Azure DevOps pipeline">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2022-03-12T21:00:00+01:00">
    <meta property="article:modified_time" content="2022-03-12T21:00:00+01:00">
    <meta property="article:tag" content="Azure DevOps">
    <meta property="article:tag" content="Pipelines">
    <meta property="article:tag" content="Hack">
    <meta property="article:tag" content="Service Connection">
    <meta property="article:tag" content="Zero Trust">
    <meta property="article:tag" content="Credentials">
    <meta property="og:image" content="https://www.devjev.nl/posts/2022/your-service-connection-credentials-are-mine/featured-image.jpg">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://www.devjev.nl/posts/2022/your-service-connection-credentials-are-mine/featured-image.jpg">
  <meta name="twitter:title" content="Your service connection credentials are mine">
  <meta name="twitter:description" content="A demonstration of service connection credentials exfiltration through an Azure DevOps pipeline">
      <meta name="twitter:site" content="@DevJevNL">
<meta name="twitter:creator" content="@DevJevNL" /><meta name="application-name" content="FixIt">
<meta name="apple-mobile-web-app-title" content="FixIt"><meta name="theme-color" data-light="#f8f8f8" data-dark="#252627" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" type="text/html" href="https://www.devjev.nl/posts/2022/your-service-connection-credentials-are-mine/" title="Your service connection credentials are mine - DevJev.nl | Azure, Cloud Security &amp; DevOps Insights for IT Professionals" /><link rel="prev" type="text/html" href="https://www.devjev.nl/posts/2022/i-am-in-your-pipeline-reading-all-your-secrets/" title="I am in your pipeline reading all your secrets!" /><link rel="next" type="text/html" href="https://www.devjev.nl/posts/2022/change-the-sharepoint-domain-name-in-your-microsoft-365-tenant/" title="Change the SharePoint domain name in your Microsoft 365 Tenant" /><link rel="stylesheet" href="/css/config.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "Your service connection credentials are mine",
    "inLanguage": "en",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "https:\/\/www.devjev.nl\/posts\/2022\/your-service-connection-credentials-are-mine\/"
    },"image": [{
              "@type": "ImageObject",
              "url": "https:\/\/www.devjev.nl\/posts\/2022\/your-service-connection-credentials-are-mine\/featured-image.jpg",
              "width":  890 ,
              "height":  368 
            }],"genre": "posts","keywords": "Azure DevOps, Pipelines, Hack, Service connection, Zero Trust, Credentials, Service Connection security, Pipeline permissions","wordcount":  1018 ,
    "url": "https:\/\/www.devjev.nl\/posts\/2022\/your-service-connection-credentials-are-mine\/","datePublished": "2022-03-12T21:00:00+01:00","dateModified": "2022-03-12T21:00:00+01:00","publisher": {
      "@type": "Organization",
      "name": ""},"author": {
        "@type": "Person",
        "name": "Jev"
      },"description": "A demonstration of service connection credentials exfiltration through an Azure DevOps pipeline"
  }
  </script><script src="/js/head/color-scheme.min.js"></script></head>
  <body data-header-desktop="fixed" data-header-mobile="auto"><div class="wrapper" data-page-style="custom"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper">
    <div class="header-title">
      <a href="/" title="DevJev.nl | Azure, Cloud Security &amp; DevOps Insights for IT Professionals"><span class="header-title-text">DevJev.nl</span></a><span class="header-subtitle"></span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a class="menu-link" href="/posts/" title="Blog posts">Posts</a></li><li class="menu-item">
              <a class="menu-link" href="/categories/" title="Post categories">Categories</a></li><li class="menu-item">
              <a class="menu-link" href="/tags/" title="Tags used in posts">Tags</a></li><li class="menu-item">
              <a class="menu-link" href="/about/" title="About Me">About</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id="search-desktop">
            <input type="text" placeholder="Search titles or contents ..." id="search-input-desktop">
            <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
              <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
            </a>
            <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Clear">
              <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
            </a>
            <span class="search-button search-loading" id="search-loading-desktop">
              <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
            </span>
          </li><li class="menu-item theme-switch" title="Switch Theme">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li></ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title="DevJev.nl | Azure, Cloud Security &amp; DevOps Insights for IT Professionals"><span class="header-title-text">DevJev.nl</span></a><span class="header-subtitle"></span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li class="search-wrapper">
            <div class="search mobile" id="search-mobile">
              <input type="text" placeholder="Search titles or contents ..." id="search-input-mobile">
              <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
              </a>
              <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
              </a>
              <span class="search-button search-loading" id="search-loading-mobile">
                <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
              </span>
            </div>
            <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
              Cancel
            </a>
          </li><li class="menu-item"><a class="menu-link" href="/posts/" title="Blog posts">Posts</a></li><li class="menu-item"><a class="menu-link" href="/categories/" title="Post categories">Categories</a></li><li class="menu-item"><a class="menu-link" href="/tags/" title="Tags used in posts">Tags</a></li><li class="menu-item"><a class="menu-link" href="/about/" title="About Me">About</a></li><li class="menu-item menu-system">
          <span class="menu-system-item theme-switch" title="Switch Theme"><i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i></span></li>
      </ul>
    </nav>
  </div>
</header><div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
  </div>
  <div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
  </div><main class="fi-container"><aside class="aside-collection animate__animated animate__fadeIn animate__faster" aria-label="Collections"></aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX"><span>Your Service Connection Credentials Are Mine</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><span class="author"><i class="fa-solid fa-user-circle" aria-hidden="true"></i>
      Jev</span></span><span class="post-included-in">&nbsp;included in <a href="/categories/security/" class="post-category" title="Category - Security"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> Security</a>&ensp;<a href="/categories/azure-devops/" class="post-category" title="Category - Azure DevOps"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> Azure DevOps</a>&ensp;<a href="/categories/azure/" class="post-category" title="Category - Azure"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> Azure</a></span></div><div class="post-meta-line"><span title="published on 2022-03-12 21:00:00"><i class="fa-solid fa-calendar-days fa-fw me-1" aria-hidden="true"></i><time datetime="2022-03-12">2022-03-12</time></span>&nbsp;<span title="1018 words"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden="true"></i>About 1100 words</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden="true"></i>5 minutes</span>&nbsp;</div>
    </div><div class="featured-image"><img src='/posts/2022/your-service-connection-credentials-are-mine/featured-image.jpg' alt="/posts/2022/your-service-connection-credentials-are-mine/featured-image.jpg"></div><div class="details toc" id="toc-static" data-kept="false">
        <div class="details-summary toc-title">
          <span>Contents</span>
          <span><i class="details-icon fa-solid fa-angle-right" aria-hidden="true"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#new-service-connection">New Service Connection</a></li>
    <li><a href="#service-connection-un-the-hood">Service connection un the hood</a></li>
    <li><a href="#getting-the-app-registration-secret">Getting the App registration secret</a></li>
  </ul>
</nav></div>
      </div><div class="content" id="content"><p>Like with the two previous posts <a href="/posts/2021/hacking-azure-devops">Hacking Azure DevOps</a> and <a href="/posts/2022/i-am-in-your-pipeline-reading-all-your-secrets">I am in your pipeline reading all your secrets!</a> I want to continue to raise awareness and understanding about pipeline security in Azure DevOps. In the previous post I have explained how secure / marked as secret variables are handled during pipeline runtime.<br>
In this post I want to show how an Azure Resource Manager service connection configuration is handled during pipeline runtime. And which sensitive information is exposed through this service connection.<br>
Like I mentioned in the  previous posts, without proper security configuration for pipelines this information could be abused by attackers.</p>
<p>But lets start with creating an out of the box Azure Resource Manager service connection.</p>
<h2 class="heading-element" id="new-service-connection"><span>New Service Connection</span>
  <a href="#new-service-connection" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>In your Azure DevOps project click on the setting icon in the bottom left corner. Next in the <code>setting</code> menu select the <code>service connection</code> option. On the new page in the top right corner click on the <code>New Service Connection</code> button. A list of the available service connection type should be visible on you right hand side. Select the <code>Azure Resource Manager</code> as shown in the following image and click next.</p>
<figure><a class="lightgallery" href="/posts/2022/your-service-connection-credentials-are-mine/1-new-service-connection.svg" title="/posts/2022/your-service-connection-credentials-are-mine/1-new-service-connection.svg" data-thumbnail="/posts/2022/your-service-connection-credentials-are-mine/1-new-service-connection.svg" data-sub-html="<h2>New service connection - Azure resource manager</h2>"><img loading="lazy" src='/posts/2022/your-service-connection-credentials-are-mine/1-new-service-connection.svg' alt="/posts/2022/your-service-connection-credentials-are-mine/1-new-service-connection.svg"></a><figcaption class="image-caption">New service connection - Azure resource manager</figcaption>
  </figure>
<p>Next, as shown in the following image select the recommended option <code>Service principal (automatic)</code> and click next.</p>
<figure><a class="lightgallery" href="/posts/2022/your-service-connection-credentials-are-mine/2-new-service-connection-automatic.svg" title="/posts/2022/your-service-connection-credentials-are-mine/2-new-service-connection-automatic.svg" data-thumbnail="/posts/2022/your-service-connection-credentials-are-mine/2-new-service-connection-automatic.svg" data-sub-html="<h2>New service connection - select automatic</h2>"><img loading="lazy" src='/posts/2022/your-service-connection-credentials-are-mine/2-new-service-connection-automatic.svg' alt="/posts/2022/your-service-connection-credentials-are-mine/2-new-service-connection-automatic.svg"></a><figcaption class="image-caption">New service connection - select automatic</figcaption>
  </figure>
<p>On the next page you should be able to see the subscriptions and resource groups to which your current account has access. Select the preferred subscription and resource group and click save. It should look as follows.</p>
<figure><a class="lightgallery" href="/posts/2022/your-service-connection-credentials-are-mine/3-new-service-connection-subscription.svg" title="/posts/2022/your-service-connection-credentials-are-mine/3-new-service-connection-subscription.svg" data-thumbnail="/posts/2022/your-service-connection-credentials-are-mine/3-new-service-connection-subscription.svg" data-sub-html="<h2>New Azure service connection</h2>"><img loading="lazy" src='/posts/2022/your-service-connection-credentials-are-mine/3-new-service-connection-subscription.svg' alt="/posts/2022/your-service-connection-credentials-are-mine/3-new-service-connection-subscription.svg"></a><figcaption class="image-caption">New Azure service connection</figcaption>
  </figure>
<div class="details admonition note open">
  <div class="details-summary admonition-title"><i class="icon fa-fw fa-solid fa-pencil-alt" aria-hidden="true"></i>Note<i class="details-icon fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></div>
  <div class="details-content">
    <div class="admonition-content">You need at least owner permissions on a single resource group and your user must be able to register applications in the Azure AD to which your subscription is linked. In case more trouble shooting is required please have a look at MS docs <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/release/azure-rm-endpoint?view=azure-devops"target="_blank" rel="external nofollow noopener noreferrer">Troubleshoot ARM service connections</a></div>
  </div>
</div>
<p>When done correctly the newly created service connection should be visible in the list. See following example.</p>
<figure><a class="lightgallery" href="/posts/2022/your-service-connection-credentials-are-mine/4-new-service-connection-created.svg" title="/posts/2022/your-service-connection-credentials-are-mine/4-new-service-connection-created.svg" data-thumbnail="/posts/2022/your-service-connection-credentials-are-mine/4-new-service-connection-created.svg" data-sub-html="<h2>Successfully created service connection</h2>"><img loading="lazy" src='/posts/2022/your-service-connection-credentials-are-mine/4-new-service-connection-created.svg' alt="/posts/2022/your-service-connection-credentials-are-mine/4-new-service-connection-created.svg"></a><figcaption class="image-caption">Successfully created service connection</figcaption>
  </figure>
<h2 class="heading-element" id="service-connection-un-the-hood"><span>Service connection un the hood</span>
  <a href="#service-connection-un-the-hood" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>Now that we have our service connection created, lets have a look under the hood. Click on the newly created service connection and the click on the managed service principal option as show in the following image.</p>
<figure><a class="lightgallery" href="/posts/2022/your-service-connection-credentials-are-mine/5-new-service-connection-properties.svg" title="/posts/2022/your-service-connection-credentials-are-mine/5-new-service-connection-properties.svg" data-thumbnail="/posts/2022/your-service-connection-credentials-are-mine/5-new-service-connection-properties.svg" data-sub-html="<h2>New service connection properties</h2>"><img loading="lazy" src='/posts/2022/your-service-connection-credentials-are-mine/5-new-service-connection-properties.svg' alt="/posts/2022/your-service-connection-credentials-are-mine/5-new-service-connection-properties.svg"></a><figcaption class="image-caption">New service connection properties</figcaption>
  </figure>
<p>You should be redirected to Azure AD page of the underlying App Registration as show in the following image.</p>
<figure><a class="lightgallery" href="/posts/2022/your-service-connection-credentials-are-mine/6-new-service-connection-principal.svg" title="/posts/2022/your-service-connection-credentials-are-mine/6-new-service-connection-principal.svg" data-thumbnail="/posts/2022/your-service-connection-credentials-are-mine/6-new-service-connection-principal.svg" data-sub-html="<h2>New service connection principal</h2>"><img loading="lazy" src='/posts/2022/your-service-connection-credentials-are-mine/6-new-service-connection-principal.svg' alt="/posts/2022/your-service-connection-credentials-are-mine/6-new-service-connection-principal.svg"></a><figcaption class="image-caption">New service connection principal</figcaption>
  </figure>
<p>To facilitate the service connection an App registration is created under the identity of the currently logged in account. We will ignore the awful looking naming that has been done to the App registration ;-). In addition a secret is also created to facilitate the use of this App registration by the service connection we just created in Azure DevOps. Click on the Certificates and secrets option in the left hand menu, the secret in question should be visible. Naturally the secret value is <em>hidden</em>. This is also show in the following image.</p>
<figure><a class="lightgallery" href="/posts/2022/your-service-connection-credentials-are-mine/7-new-service-connection-principal-secret.svg" title="/posts/2022/your-service-connection-credentials-are-mine/7-new-service-connection-principal-secret.svg" data-thumbnail="/posts/2022/your-service-connection-credentials-are-mine/7-new-service-connection-principal-secret.svg" data-sub-html="<h2>New service connection principal secret</h2>"><img loading="lazy" src='/posts/2022/your-service-connection-credentials-are-mine/7-new-service-connection-principal-secret.svg' alt="/posts/2022/your-service-connection-credentials-are-mine/7-new-service-connection-principal-secret.svg"></a><figcaption class="image-caption">New service connection principal secret</figcaption>
  </figure>
<p>In addition this app registration is also added as contributor to the resource group or any other scope that is selected during the creation process. In the case of this example I have selected the resource group called demo-ado-scraper. Have a look at the following image.</p>
<figure><a class="lightgallery" href="/posts/2022/your-service-connection-credentials-are-mine/8-new-service-connection-principal-permissions.svg" title="/posts/2022/your-service-connection-credentials-are-mine/8-new-service-connection-principal-permissions.svg" data-thumbnail="/posts/2022/your-service-connection-credentials-are-mine/8-new-service-connection-principal-permissions.svg" data-sub-html="<h2>New service connection principal permissions</h2>"><img loading="lazy" src='/posts/2022/your-service-connection-credentials-are-mine/8-new-service-connection-principal-permissions.svg' alt="/posts/2022/your-service-connection-credentials-are-mine/8-new-service-connection-principal-permissions.svg"></a><figcaption class="image-caption">New service connection principal permissions</figcaption>
  </figure>
<p>So an App registration with a secret is created and contributor permissions are applied to the selected scope. Meaning that if it would be possible to obtain the App registration details including secret from within a pipeline, it would allow an attacker to at the very least gain contributor permissions over all the resources available under the selected permissions scope. In my case that would be the resource group.<br>
Lets have have a look how we can achieve this.</p>
<h2 class="heading-element" id="getting-the-app-registration-secret"><span>Getting the App registration secret</span>
  <a href="#getting-the-app-registration-secret" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>Ideally to get any kind of authentication and authorization going the following values would be required.</p>
<ul>
<li>Secret set for the the service connection app registration</li>
<li>App registration Id of the service connection app registration</li>
<li>Tenant Id of the service connection app registration</li>
</ul>
<p>Since it is actually possible to get all 3 values using PowerShell a simple pipeline with a Powershell task which exposes the <code>SYSTEM_ACCESSTOKEN</code> should be more then sufficient to get the job done.
The clue lies within the warning that is given when using the <code>Connect-AzAccount -ServicePrincipal</code> which reads as following</p>
<div class="details admonition warning open">
  <div class="details-summary admonition-title"><i class="icon fa-fw fa-solid fa-exclamation-triangle" aria-hidden="true"></i>Warning<i class="details-icon fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></div>
  <div class="details-content">
    <div class="admonition-content">The provided service principal secret will be included in the &lsquo;AzureRmContext.json&rsquo; file found in the user profile ( C:\Users\DevJev.Azure ). Please ensure that this directory has appropriate protections.</div>
  </div>
</div>
<p>It tells us that when logging in using an App registration with a secret this secret is stored inside a file on the system. This file can be retrieved and parsed. The following script does exactly that.</p>
<script src="https://gist.github.com/devjevnl/d7d48e8989a6438b60bd6759aac24fa6.js?file=snippet-1.ps1"></script>
<p>Take a closer look at the file we just retrieved, you will notice that each context is stored under its own name. We can get the name of our current context by simply using <code>\$contextName = \$(Get-AzContext).Name</code> command. With the context name sorted its simply down to sifting through the json properties. And the ones we where interested in are as follows.</p>
<ul>
<li>The app registration Id is retrieved by <code>\$azureRmContextJson.Contexts.$contextName.Account.Id </code></li>
<li>The app registration secret is retrieved by <code>\$azureRmContextJson.Contexts.$contextName.Account.ExtendedProperties.ServicePrincipalSecret</code></li>
<li>The tenant Id is retrieved by <code>\$azureRmContextJson.Contexts.$contextName.Tenant.Id</code></li>
</ul>
<p>The full script combined with the yaml task is as follows.</p>
<script src="https://gist.github.com/devjevnl/d7d48e8989a6438b60bd6759aac24fa6.js?file=snippet-2.ps1"></script>
<p>When the above task is executed in a pipeline the pipeline output will contain the Base64 encoded strings for each of the variable values. As show in the following clipping.</p>
<figure><a class="lightgallery" href="/posts/2022/your-service-connection-credentials-are-mine/9-pipeline-result.svg" title="/posts/2022/your-service-connection-credentials-are-mine/9-pipeline-result.svg" data-thumbnail="/posts/2022/your-service-connection-credentials-are-mine/9-pipeline-result.svg" data-sub-html="<h2>Pipeline result</h2>"><img loading="lazy" src='/posts/2022/your-service-connection-credentials-are-mine/9-pipeline-result.svg' alt="/posts/2022/your-service-connection-credentials-are-mine/9-pipeline-result.svg"></a><figcaption class="image-caption">Pipeline result</figcaption>
  </figure>
<p>After using the decoding script from <a href="/posts/2022/i-am-in-your-pipeline-reading-all-your-secrets/">I am in your pipeline reading all your secrets!</a> post the decoded values are as how in the following image.</p>
<figure><a class="lightgallery" href="/posts/2022/your-service-connection-credentials-are-mine/10-pipeline-result-decoded.svg" title="/posts/2022/your-service-connection-credentials-are-mine/10-pipeline-result-decoded.svg" data-thumbnail="/posts/2022/your-service-connection-credentials-are-mine/10-pipeline-result-decoded.svg" data-sub-html="<h2>Pipeline result decoded</h2>"><img loading="lazy" src='/posts/2022/your-service-connection-credentials-are-mine/10-pipeline-result-decoded.svg' alt="/posts/2022/your-service-connection-credentials-are-mine/10-pipeline-result-decoded.svg"></a><figcaption class="image-caption">Pipeline result decoded</figcaption>
  </figure>
<p>With these values exfiltrated an attacker is now able to access your Azure resources at with contributor permissions. For example by using the <code>Connect-AzAccount</code></p>
<figure><a class="lightgallery" href="/posts/2022/your-service-connection-credentials-are-mine/11-example-connect.svg" title="/posts/2022/your-service-connection-credentials-are-mine/11-example-connect.svg" data-thumbnail="/posts/2022/your-service-connection-credentials-are-mine/11-example-connect.svg" data-sub-html="<h2>Example connect</h2>"><img loading="lazy" src='/posts/2022/your-service-connection-credentials-are-mine/11-example-connect.svg' alt="/posts/2022/your-service-connection-credentials-are-mine/11-example-connect.svg"></a><figcaption class="image-caption">Example connect</figcaption>
  </figure>
<p>Please make sure to secure your pipeline access and use this blog post as an example to grow understanding in your organization about why pipeline security is a crucial security topic.
Thank you for taking the time to read this post!</p>
</div><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod"><span title="Updated on 2022-03-12 21:00:00">Updated on 2022-03-12&nbsp;</span>
      </div></div><div class="post-info-line">
        <div class="post-info-md"></div>
        <div class="post-info-share">
          <span></span>
        </div>
      </div></div>

  <div class="post-info-more">
    <section class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href="/tags/azure-devops/" class="post-tag" title="Tags - Azure DevOps">Azure DevOps</a><a href="/tags/pipelines/" class="post-tag" title="Tags - Pipelines">Pipelines</a><a href="/tags/hack/" class="post-tag" title="Tags - Hack">Hack</a><a href="/tags/service-connection/" class="post-tag" title="Tags - Service Connection">Service Connection</a><a href="/tags/zero-trust/" class="post-tag" title="Tags - Zero Trust">Zero Trust</a><a href="/tags/credentials/" class="post-tag" title="Tags - Credentials">Credentials</a><a href="/tags/service-connection-security/" class="post-tag" title="Tags - Service Connection Security">Service Connection Security</a><a href="/tags/pipeline-permissions/" class="post-tag" title="Tags - Pipeline Permissions">Pipeline Permissions</a></section>
    <section><span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
    </section>
  </div><div class="post-nav"><a href="/posts/2022/i-am-in-your-pipeline-reading-all-your-secrets/" class="post-nav-item" rel="prev" title="I Am in Your Pipeline Reading All Your Secrets!"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i>I Am in Your Pipeline Reading All Your Secrets!</a><a href="/posts/2022/change-the-sharepoint-domain-name-in-your-microsoft-365-tenant/" class="post-nav-item" rel="next" title="Change the SharePoint Domain Name in Your Microsoft 365 Tenant">Change the SharePoint Domain Name in Your Microsoft 365 Tenant<i class="fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article>

  <aside class="toc" id="toc-auto" aria-label="Contents"><h2 class="toc-title">Contents&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden="true"></i></h2>
      <div class="toc-content always-active" id="toc-content-auto"></div></aside></main><footer class="footer">
    <div class="footer-container"><div class="custom-footer-text">
  <p>Â© 2025 Jev Suchoi - Let's automate the boring! </p>
</div>
<div class="footer-line copyright" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright fa-fw" aria-hidden="true"></i>
            <span itemprop="copyrightYear">2025</span><span class="author" itemprop="copyrightHolder">
              <a href="/"></a></span></div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role="button" aria-label="Back to Top"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><span class="variant-numeric d-none">0%</span>
        </div></div><div id="mask"></div><noscript>
    <div class="noscript-warning">This website works best with JavaScript enabled.</div>
  </noscript>
</div><link rel="stylesheet" href="/lib/lightgallery/css/lightgallery-bundle.min.css"><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><script src="/lib/autocomplete/autocomplete.min.js" defer></script><script src="/lib/fuse/fuse.min.js" defer></script><script src="/lib/lightgallery/lightgallery.min.js" defer></script><script src="/lib/lightgallery/plugins/thumbnail/lg-thumbnail.min.js" defer></script><script src="/lib/lightgallery/plugins/zoom/lg-zoom.min.js" defer></script><script src="/lib/cookieconsent/cookieconsent.min.js" defer></script><script src="/posts/2022/your-service-connection-credentials-are-mine/config.js" defer></script><script src="/js/theme.min.js" defer></script><script>
      window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());
      gtag('config', 'G-J3E897NYLC');
    </script><script src="https://www.googletagmanager.com/gtag/js?id=G-J3E897NYLC" async></script></body>
</html>
